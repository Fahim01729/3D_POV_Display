

// Define the pin connections and settings
const int DATA_PIN = 11;      // SPI MOSI pin (Master Out Slave In)
const int CLOCK_PIN = 13;     // SPI SCK pin (Clock)
const int HALL_SENSOR_PIN = 2;  // Hall sensor for detecting the magnet position

// LED Display configuration
const int NUM_FRAMES = 25;
const int NUM_ROWS = 4;
const int NUM_COLS = 8;

// SPI settings for SK9822 (adjust clock speed as necessary for your setup)
SPISettings spiSettings(12000000, MSBFIRST, SPI_MODE0);

// Variables for frame timing and synchronization
int currentFrame = 0;
unsigned long lastUpdateTime = 0;
unsigned long frameDuration = 1500 / NUM_FRAMES;  // Duration of each frame in milliseconds

void setup() {
  pinMode(DATA_PIN, OUTPUT);
  pinMode(CLOCK_PIN, OUTPUT);
  pinMode(HALL_SENSOR_PIN, INPUT_PULLUP);

  SPI.begin();
}

void loop() {
  if (digitalRead(HALL_SENSOR_PIN) == LOW) {
    unsigned long currentTime = millis();
    if (currentTime - lastUpdateTime >= frameDuration) {
      updateLEDs();
      currentFrame = (currentFrame + 1) % NUM_FRAMES;
      lastUpdateTime = currentTime;
    }
  }
}

void updateLEDs() {
  SPI.beginTransaction(spiSettings);

  // Send the data for the current frame
  for (int row = 0; row < NUM_ROWS; row++) {
    for (int col = 0; col < NUM_COLS; col++) {
      SPI.transfer(image[currentFrame][row][col]);
    }
  }

  SPI.endTransaction();
}
